<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
<mapper namespace="com.hw.dao.OrderDAO">

	<select id="getOrderMasterVOUniqueId" resultType="String">
		SELECT CONCAT(DATE_FORMAT(NOW(), '%Y%m%d'), UPPER(SUBSTR(MD5(RAND()),1,6))) FROM DUAL
	</select>
	
	<select id="getOrderMasterVOIdDupliChkCount" resultType="Integer" parameterType="String">
		SELECT COUNT(1) AS id_cnt FROM order_master_history WHERE id = #{id}
	</select>
	
	<insert id="insertOrderMasterVO" parameterType="orderMasterVO">
		INSERT INTO order_master
		(
			id
			, order_date
			, order_name
			, tot_order_price
			, order_state_cd
			, orderer_user_id
			, orderer_name
			, orderer_hp_number
			, orderer_mail
			, recipient_name
			, recipient_hp_number
			, recipient_hp_number2
			, recipient_jibun_addr
			, recipient_road_addr
			, recipient_detail_addr
			, recipient_zipcode
			, order_request
			, delivery_request
			, payment_method
			, waybill_number
			, video_request_cd
			, reg_dtm
		)
		VALUES
		(
			#{id}
			, NOW()
			, #{orderName}
			, #{totOrderPrice}
			, #{orderStateCd}
			, #{ordererUserId}
			, #{ordererName}
			, #{ordererHpNumber}
			, #{ordererMail}
			, #{recipientName}
			, #{recipientHpNumber}
			, #{recipientHpNumber2}
			, #{recipientJibunAddr}
			, #{recipientRoadAddr}
			, #{recipientDetailAddr}
			, #{recipientZipcode}
			, #{orderRequest}
			, #{deliveryRequest}
			, #{paymentMethod}
			, #{waybillNumber}
			, #{videoRequestCd}
			, NOW()
		)
	</insert>
	
	<delete id="deleteOrderMasterVO" parameterType="String">
		DELETE
		FROM
			order_master
		WHERE
			id = #{id}
	</delete>
	
	<update id="updateOrderMasterVO" parameterType="orderMasterVO">
		UPDATE
			order_master
		SET
			order_date               = #{orderDate}          
			, order_name             = #{orderName}          
			, tot_order_price        = #{totOrderPrice}      
			, order_state_cd         = #{orderStateCd}       
			, orderer_user_id        = #{ordererUserId}      
			, orderer_name           = #{ordererName}        
			, orderer_hp_number      = #{ordererHpNumber}    
			, orderer_mail           = #{ordererMail}        
			, recipient_name         = #{recipientName}      
			, recipient_hp_number    = #{recipientHpNumber}  
			, recipient_hp_number2   = #{recipientHpNumber2} 
			, recipient_jibun_addr   = #{recipientJibunAddr} 
			, recipient_road_addr    = #{recipientRoadAddr}  
			, recipient_detail_addr  = #{recipientDetailAddr}
			, recipient_zipcode      = #{recipientZipcode}   
			, order_request          = #{orderRequest}       
			, delivery_request       = #{deliveryRequest}    
			, payment_method         = #{paymentMethod}      
			, waybill_number         = #{waybillNumber}
			, video_request_cd       = #{videoRequestCd}      
			, updt_dtm               = NOW()
		WHERE
			id = #{id}
	</update>
	
	<insert id="insertOrderMasterHistoryVO" parameterType="orderMasterHistoryVO">
		INSERT INTO order_master_history
		(
			id
			, history_seq
			, order_date
			, order_name
			, tot_order_price
			, order_state_cd
			, orderer_user_id
			, orderer_name
			, orderer_hp_number
			, orderer_mail
			, recipient_name
			, recipient_hp_number
			, recipient_hp_number2
			, recipient_jibun_addr
			, recipient_road_addr
			, recipient_detail_addr
			, recipient_zipcode
			, order_request
			, delivery_request
			, payment_method
			, waybill_number
			, video_request_cd
			, reg_dtm
			, history_contents
		)
		VALUES
		(
			#{id}
			, #{historySeq}
			, #{orderDate}
			, #{orderName}
			, #{totOrderPrice}
			, #{orderStateCd}
			, #{ordererUserId}
			, #{ordererName}
			, #{ordererHpNumber}
			, #{ordererMail}
			, #{recipientName}
			, #{recipientHpNumber}
			, #{recipientHpNumber2}
			, #{recipientJibunAddr}
			, #{recipientRoadAddr}
			, #{recipientDetailAddr}
			, #{recipientZipcode}
			, #{orderRequest}
			, #{deliveryRequest}
			, #{paymentMethod}
			, #{waybillNumber}
			, #{videoRequestCd}
			, NOW()
			, #{historyContents}
		)
	</insert>
	
	<select id="getOrderMasterHistoryVOMaxHistorySeq" resultType="Integer" parameterType="String">
		SELECT IFNULL(MAX(history_seq), 0)+1 AS history_seq FROM order_master_history WHERE id = #{id} 
	</select>
	
	<delete id="deleteOrderMasterHistoryVO" parameterType="String">
		DELETE
		FROM
			order_master_history
		WHERE
			id = #{id}
	</delete>
	
	<select id="getOrderMasterAllList" resultType="orderMasterVO"  parameterType="orderMasterVO">
		SELECT 
			a.id                                                                                   AS id                 
			, a.order_date                                                                         AS orderDate
			, DATE_FORMAT(a.order_date, '%Y-%m-%d')                                                AS orderDateStr                    
			, a.order_name                                                                         AS orderName          
			, a.tot_order_price                                                                    AS totOrderPrice
			, FORMAT(a.tot_order_price, 0)                                                         AS totOrderPriceStr      
			, a.order_state_cd                                                                     AS orderStateCd       
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'ORD001' AND cd = a.order_state_cd)   AS orderStateCdNm     
			, a.orderer_user_id                                                                    AS ordererUserId      
			, a.orderer_name                                                                       AS ordererName        
			, a.orderer_hp_number                                                                  AS ordererHpNumber    
			, a.orderer_mail                                                                       AS ordererMail        
			, a.recipient_name                                                                     AS recipientName      
			, a.recipient_hp_number                                                                AS recipientHpNumber  
			, a.recipient_hp_number2                                                               AS recipientHpNumber2 
			, a.recipient_jibun_addr                                                               AS recipientJibunAddr 
			, a.recipient_road_addr                                                                AS recipientRoadAddr  
			, a.recipient_detail_addr                                                              AS recipientDetailAddr
			, a.recipient_zipcode                                                                  AS recipientZipcode   
			, a.order_request                                                                      AS orderRequest       
			, a.delivery_request                                                                   AS deliveryRequest    
			, a.payment_method                                                                     AS paymentMethod      
			, a.waybill_number                                                                     AS waybillNumber
			, a.video_request_cd                                                                   AS videoRequestCd
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'ORD002' AND cd = a.video_request_cd) AS videoRequestCdNm      
			, a.reg_dtm                                                                            AS regDtm             
			, a.updt_dtm                                                                           AS updtDtm            
		FROM
			order_master a
		<where>
		    <if test="id != null and id != ''">
		    	AND a.id = #{id}
		    </if>
		    <if test="ordererUserId != null and ordererUserId != ''">
		    	AND a.orderer_user_id = #{ordererUserId}
		    </if>
		</where>
	</select>
	
	<insert id="insertOrderDetailVO" parameterType="orderDetailVO">
		INSERT INTO order_detail
		(
			id
			, seq
			, product_id
			, product_price
			, product_order_qty
			, reg_dtm
			, box_qty
			, box_tot_price
		)
		VALUES
		(
			#{id}
			, #{seq}
			, #{productId}
			, #{productPrice}
			, #{productOrderQty}
			, NOW()
			, #{boxQty}
			, #{boxTotPrice}
		)
	</insert>
	
	<delete id="deleteOrderDetailVO" parameterType="String">
		DELETE
		FROM
			order_detail
		WHERE
			id = #{id}
	</delete>
	
	<select id="getOrderDetailAllList" resultType="orderDetailVO"  parameterType="orderDetailVO">
		SELECT 
			a.id                                                                                   AS id             
			, a.seq                                                                                AS seq            
			, a.product_id                                                                         AS productId      
			, a.product_price                                                                      AS productPrice   
			, a.product_order_qty                                                                  AS productOrderQty
			, a.box_qty                                                                            AS boxQty
			, a.box_tot_price                                                                      AS boxTotPrice
			, a.reg_dtm                                                                            AS regDtm
			, b.product_name                                                                       AS productName
			, b.product_description                                                                AS productDescription
			, b.product_image                                                                      AS productImage
		FROM
			order_detail a
			LEFT OUTER JOIN 
			-- product_master b
			-- 23.11.04 order_detail 조회 시 product_master 테이블과 banpum_master 테이블 전부를 참조하도록 수정함.
			(
			 SELECT z.id AS id
				, z.product_name AS product_name
				, z.product_description AS product_description
				, z.product_image AS product_image
			FROM product_master z
			UNION ALL
			SELECT x.id AS id
				, x.banpum_name AS product_name
				, x.banpum_description AS product_description
				, x.banpum_image1 AS product_image
			FROM banpum_master x
			 ) b
			ON a.product_id = b.id
		<where>
		    <if test="id != null and id != ''">
		    	AND a.id = #{id}
		    </if>
		    
		    <if test="productId != null and productId != ''">
		    	AND a.product_id = #{productId}
		    </if>
		</where>
	</select>
	
	<select id="getOrderDetailAndRefundInfoListById" resultType="orderDetailVO"  parameterType="String">
		SELECT 
			a.id                                                                                   AS id             
			, a.seq                                                                                AS seq            
			, a.product_id                                                                         AS productId      
			, a.product_price                                                                      AS productPrice   
			, a.product_order_qty                                                                  AS productOrderQty
			, a.box_qty                                                                            AS boxQty
			, a.box_tot_price                                                                      AS boxTotPrice
			, a.reg_dtm                                                                            AS regDtm
			, b.product_name                                                                       AS productName
			, b.product_description                                                                AS productDescription
			, b.product_image                                                                      AS productImage
			, c.id                                                                                 AS refundId
			, c.refund_qty                                                                         AS refundQty
			, c.tot_refund_price                                                                   AS totRefundPrice
			, c.refund_state_cd                                                                    AS refundStateCd
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'ORD004' AND cd = c.refund_state_cd)  AS refundStateCdNm
			, c.refund_reason_cd                                                                   AS refundReasonCd
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'ORD003' AND cd = c.refund_reason_cd) AS refundReasonCdNm
			, c.refund_reason_user_write                                                           AS refundReasonUserWrite
			, c.refund_content                                                                     AS refundContent
			, c.refund_remarks                                                                     AS refundRemarks
		FROM
			order_detail a
			LEFT OUTER JOIN 
				(
				 SELECT z.id AS id
					, z.product_name AS product_name
					, z.product_description AS product_description
					, z.product_image AS product_image
				FROM product_master z
				UNION ALL
				SELECT x.id AS id
					, x.banpum_name AS product_name
					, x.banpum_description AS product_description
					, x.banpum_image1 AS product_image
				FROM banpum_master x
				 ) b
			ON a.product_id = b.id
			LEFT OUTER JOIN
				refund_info c
			ON a.id = c.order_id
			AND a.seq = c.order_seq
		WHERE
			a.id = #{id}
	</select>
	
	<select id="getRefundInfoVOMaxId" resultType="String">
		SELECT CONCAT('REFUND', (SELECT LPAD(IFNULL(MAX(SUBSTR(TRIM(id), 7)), 0)+1, 9, '0') FROM refund_info)) AS id FROM DUAL
	</select>
	
	<select id="getRefundInfoAllList" resultType="refundInfoVO"  parameterType="refundInfoVO">
		SELECT 
			a.id                                                                                   AS id                   
			, a.order_id                                                                           AS orderId              
			, a.order_seq                                                                          AS orderSeq             
			, a.product_id                                                                         AS productId            
			, a.product_price                                                                      AS productPrice         
			, a.refund_qty                                                                         AS refundQty            
			, a.tot_refund_price                                                                   AS totRefundPrice       
			, a.refund_state_cd                                                                    AS refundStateCd        
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'ORD004' AND cd = a.refund_state_cd)  AS refundStateCdNm
			, a.refund_reason_cd                                                                   AS refundReasonCd       
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'ORD003' AND cd = a.refund_reason_cd) AS refundReasonCdNm
			, a.refund_reason_user_write                                                           AS refundReasonUserWrite
			, a.refund_content                                                                     AS refundContent
			<![CDATA[
			, REPLACE(REPLACE(a.refund_content  , '\n', '<br>'), '\r', '')               AS refundContentStr
			]]>
			, a.refund_remarks                                                                     AS refundRemarks        
			, a.reg_dtm                                                                            AS regDtm               
			, a.updt_dtm                                                                           AS updtDtm              
		FROM
			refund_info a
		<where>
		    <if test="id != null and id != ''">
		    	AND a.id = #{id}
		    </if>
		    <if test="orderId != null and orderId != ''">
		    	AND a.order_id = #{orderId}
		    </if>
		    <if test="orderSeq != null and orderSeq != ''">
		    	AND a.order_seq = #{orderSeq}
		    </if>
		</where>
	</select>
	
	<insert id="insertRefundInfoVO" parameterType="refundInfoVO">
		INSERT INTO refund_info
		(
			id
			, order_id
			, order_seq
			, product_id
			, product_price
			, refund_qty
			, tot_refund_price
			, refund_state_cd
			, refund_reason_cd
			, refund_reason_user_write
			, refund_content
			, refund_remarks
			, reg_dtm
		)
		VALUES
		(
			#{id}
			, #{orderId}
			, #{orderSeq}
			, #{productId}
			, #{productPrice}
			, #{refundQty}
			, #{totRefundPrice}
			, #{refundStateCd}
			, #{refundReasonCd}
			, #{refundReasonUserWrite}
			, #{refundContent}
			, #{refundRemarks}
			, NOW()
		)
	</insert>
	
	<update id="updateRefundInfoVO" parameterType="refundInfoVO">
		UPDATE
			refund_info
		SET
			order_id                             = #{orderId}              
			, order_seq                          = #{orderSeq}             
			, product_id                         = #{productId}            
			, product_price                      = #{productPrice}         
			, refund_qty                         = #{refundQty}            
			, tot_refund_price                   = #{totRefundPrice}       
			, refund_state_cd                    = #{refundStateCd}        
			, refund_reason_cd                   = #{refundReasonCd}       
			, refund_reason_user_write           = #{refundReasonUserWrite}
			, refund_content                     = #{refundContent}        
			, refund_remarks                     = #{refundRemarks}        
			, updt_dtm                           = NOW()                   
		WHERE
			id = #{id}
	</update>
	
	<delete id="deleteRefundInfoVO" parameterType="String">
		DELETE
		FROM
			refund_info
		WHERE
			id = #{id}
	</delete>
	
	<select id="getRefundInfoListByOrderIds" resultType="refundInfoVO"  parameterType="String">
		SELECT 
			a.id                                                                                   AS id                   
			, a.order_id                                                                           AS orderId              
			, a.order_seq                                                                          AS orderSeq             
			, a.product_id                                                                         AS productId            
			, a.product_price                                                                      AS productPrice         
			, a.refund_qty                                                                         AS refundQty            
			, a.tot_refund_price                                                                   AS totRefundPrice       
			, a.refund_state_cd                                                                    AS refundStateCd        
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'ORD004' AND cd = a.refund_state_cd)  AS refundStateCdNm
			, a.refund_reason_cd                                                                   AS refundReasonCd       
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'ORD003' AND cd = a.refund_reason_cd) AS refundReasonCdNm
			, a.refund_reason_user_write                                                           AS refundReasonUserWrite
			, a.refund_content                                                                     AS refundContent
			<![CDATA[
			, REPLACE(REPLACE(a.refund_content  , '\n', '<br>'), '\r', '')               AS refundContentStr
			]]>
			, a.refund_remarks                                                                     AS refundRemarks        
			, a.reg_dtm                                                                            AS regDtm               
			, a.updt_dtm                                                                           AS updtDtm              
		FROM
			refund_info a
		WHERE
			a.order_id IN 
	        <foreach collection="array" item="item" open="(" close=")" index="index" separator=",">
	            #{item}
	        </foreach>
	</select>
	
</mapper>