<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
<mapper namespace="com.hw.dao.ProductDAO">

	<select id="getProductMasterVOMaxId" resultType="String">
		SELECT CONCAT('PRODUCT', (SELECT LPAD(IFNULL(MAX(SUBSTR(TRIM(id), 8)), 0)+1, 6, '0') FROM product_master)) AS id FROM DUAL
	</select>
	
	<insert id="insertProductMasterVO" parameterType="productMasterVO">
		INSERT INTO product_master
		(
			id
			, product_name
			, product_price
			, product_qty
			, product_description
			, product_image
			, reg_dtm
			, updt_dtm
		)
		VALUES
		(
			#{id}
			, #{productName}
			, #{productPrice}
			, #{productQty}
			, #{productDescription}
			, #{productImage}
			, NOW()
			, #{updtDtm}
		)
	</insert>
	
	<select id="getProductMasterAllList" resultType="productMasterVO">
		SELECT 
			a.id                                                                             	AS id                
			, a.product_name                                                                    AS productName       
			, a.product_price                                                                   AS productPrice
			, FORMAT(a.product_price, 0)                                                        AS productPriceStr
			, a.product_qty                                                                     AS productQty      
			, a.product_description                                                             AS productDescription
			, a.product_image                                                                   AS productImage
			, (SELECT GROUP_CONCAT(parts_name SEPARATOR '|') FROM product_detail WHERE id = a.id) AS productDetailListStr
			, a.reg_dtm                                                                         AS regDtm            
			, a.updt_dtm                                                                        AS updtDtm            
		FROM
			product_master a
	</select>
	
	<insert id="insertProductDetailVO" parameterType="productDetailVO">
		INSERT INTO product_detail
		(
			id
			, seq
			, parts_type_cd
			, parts_id
			, parts_name
			, parts_qty
			, parts_price
			, parts_total_price
			, parts_image
			, reg_dtm
			, updt_dtm
		)
		VALUES
		(
			#{id}
			, #{seq}
			, #{partsTypeCd}
			, #{partsId}
			, #{partsName}
			, #{partsQty}
			, #{partsPrice}
			, #{partsTotalPrice}
			, #{partsImage}
			, NOW()
			, #{updtDtm}
		)
	</insert>
	
	<select id="getEventMallList" resultType="productMasterVO">
		SELECT 
			a.id                                                                             	AS id                
			, a.product_name                                                                    AS productName       
			, a.product_price                                                                   AS productPrice
			, a.product_qty                                                                     AS productQty      
			, a.product_description                                                             AS productDescription
			, a.product_image                                                                   AS productImage      
			, a.reg_dtm                                                                         AS regDtm            
			, a.updt_dtm                                                                        AS updtDtm
			<!-- , CONCAT(a.product_name, '&lt;br&gt;', FORMAT(a.product_price, 0), '원&lt;br&gt;', REPLACE(a.product_description, '\n', '&lt;br&gt;')) AS eventMallInfo -->
			<![CDATA[
			, CONCAT('<b>', a.product_name, '</b><br><br>', FORMAT(a.product_price, 0), '원<br><br>', REPLACE(a.product_description, '\n', '<br>')) AS eventMallInfo
			]]>
		FROM
			product_master a
		WHERE
			a.product_qty >= 1
	</select>
	
	<select id="getProductMasterById" parameterType="String" resultType="productMasterVO">
		SELECT 
			a.id                                                                             	AS id                
			, a.product_name                                                                    AS productName       
			, a.product_price                                                                   AS productPrice
			, CONCAT(FORMAT(a.product_price, 0), '원')                                           AS productPriceStr
			, a.product_qty                                                                     AS productQty      
			, a.product_description                                                             AS productDescription
			<![CDATA[
			, REPLACE(a.product_description, '\n', '<br>')                                      AS productDescriptionStr
			]]>
			, a.product_image                                                                   AS productImage      
			, a.reg_dtm                                                                         AS regDtm            
			, a.updt_dtm                                                                        AS updtDtm
		FROM
			product_master a
		WHERE
			a.id = #{id}
	</select>
	
	<update id="updateProductMasterVO" parameterType="productMasterVO">
		UPDATE
			product_master
		SET
			id                    			= #{id}                
			, product_name        			= #{productName}       
			, product_price       			= #{productPrice}      
			, product_qty         			= #{productQty}        
			, product_description 			= #{productDescription}
			, product_image       			= #{productImage}      
			, updt_dtm            			= NOW()                
		WHERE
			id = #{id}
	</update>
	
	<select id="getProductDetailById" parameterType="String" resultType="productDetailVO">
		SELECT 
			a.id                                                                              AS id             
			, a.seq                                                                           AS seq            
			, a.parts_type_cd                                                                 AS partsTypeCd    
			, (SELECT nm FROM comn_cd_detail WHERE comn_cd = 'COM003' AND cd = a.parts_type_cd )     AS partsTypeCdNm    
			, a.parts_id                                                                      AS partsId
			, a.parts_name                                                                    AS partsName        
			, a.parts_qty                                                                     AS partsQty            
			, a.parts_price                                                                   AS partsPrice     
			, a.parts_total_price                                                             AS partsTotalPrice
			, a.parts_image                                                                   AS partsImage     
			, a.reg_dtm                                                                       AS regDtm         
			, a.updt_dtm                                                                      AS updtDtm        
		FROM
			product_detail a 
		WHERE
			a.id = #{id}
	</select>
	
	<delete id="deleteProductDetailVO" parameterType="productDetailVO">
		DELETE
		FROM
			product_detail
		WHERE
			id = #{id}
	</delete>
	
</mapper>